name: CI - Build and Push Login Docker Image

on:
  push:
    tags: [ 'v*' ]   # â¬…ï¸ triggers on version tags like v1.0.0
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ·ï¸ Set image tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"     # Use the Git tag as Docker tag
          else
            BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | tr '/' '-')
            if [ "$BRANCH_NAME" = "master" ]; then
              IMAGE_TAG="latest"
            else
              IMAGE_TAG="$BRANCH_NAME"
            fi
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ðŸ“¦ Build Login Service Docker image
        run: |
          docker build -t chanuth/my-login:login.${IMAGE_TAG} .

      - name: ðŸ“¤ Push Login Service Docker image
        run: |
          docker push chanuth/my-login:login.${IMAGE_TAG}
